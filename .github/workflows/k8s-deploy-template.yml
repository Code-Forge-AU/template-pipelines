name: Reusable Kubernetes Deployment Workflow

on:
  workflow_call:
    inputs:
      services:
        description: 'List of services to build and deploy'
        required: true
        type: string
      pulumi_stack:
        description: 'Pulumi stack name'
        required: true
        type: string
      pulumi_work_dir:
        description: 'Directory containing Pulumi project'
        required: true
        type: string
    secrets:
      pulumi_access_token:
        required: true

jobs:
  build_push_and_deploy:
    name: Build, Push, and Deploy
    runs-on: [j8s-vps]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build and Push Docker Images
        run: |
          # Read the services input
          services='${{ inputs.services }}'
          
          # Process each service
          while IFS= read -r line; do
            if [[ $line == "- name:"* ]]; then
              # Start of a new service
              service_name=$(echo "$line" | awk '{print $3}')
            elif [[ $line == "  dir:"* ]]; then
              build_dir=$(echo "$line" | awk '{print $2}')
            elif [[ $line == "  dockerfile:"* ]]; then
              dockerfile=$(echo "$line" | awk '{print $2}')
              
              echo "Building $service_name from $build_dir using $dockerfile"
              
              # Change to the build directory
              cd "$GITHUB_WORKSPACE/$build_dir" || exit 1
              
              # Build the Docker image
              docker build -f "$dockerfile" -t "$service_name:latest" .
              
              # Tag the image for the local registry
              docker tag "$service_name:latest" "localhost:32000/$service_name:latest"
              
              # Push the image to the local registry
              docker push "localhost:32000/$service_name:latest"
              
              # Return to the workspace root
              cd "$GITHUB_WORKSPACE" || exit 1
            fi
          done <<< "$services"
        shell: /usr/bin/bash -e {0}

      - name: Deploy with Pulumi
        uses: pulumi/actions@v6
        with:
          command: up
          stack-name: ${{ inputs.pulumi_stack }}
          work-dir: ${{ inputs.pulumi_work_dir }}
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.pulumi_access_token }}